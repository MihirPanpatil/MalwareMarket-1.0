from django.shortcuts import render

# Create your views here.
from django.shortcuts import render, redirect
from django.core.files.storage import FileSystemStorage
from .models import IPFSFile
from .ipfs_handler import IPFSHandler
import os

def home(request):
    return render(request, 'ipfs_hosting/home.html')

def upload_file(request):
    if request.method == 'POST' and request.FILES['file']:
        file = request.FILES['file']
        fs = FileSystemStorage()
        filename = fs.save(file.name, file)
        file_path = fs.path(filename)
        
        ipfs_handler = IPFSHandler()
        ipfs_hash = ipfs_handler.upload_file(file_path)
        
        # Create index.html symlink for directory listing
        if file.name.endswith('.html'):
            index_path = os.path.join(os.path.dirname(file_path), 'index.html')
            if not os.path.exists(index_path):
                os.symlink(file_path, index_path)
        
        IPFSFile.objects.create(
            file_name=filename,
            ipfs_hash=ipfs_hash
        )
        
        os.remove(file_path)
        return redirect('file_list')
    
    return render(request, 'ipfs_hosting/upload.html')



from django.http import HttpResponse
import requests

from django.http import HttpResponse
import requests

def serve_ipfs_content(request, ipfs_hash):
    ipfs_handler = IPFSHandler()
    content = ipfs_handler.get_file(ipfs_hash)
    
    if content:
        return HttpResponse(content, content_type='text/html')
    return HttpResponse('Content not available', status=404)


def file_list(request):
    files = IPFSFile.objects.all()
    for file in files:
        file.view_url = f'/ipfs/{file.ipfs_hash}'
    return render(request, 'ipfs_hosting/file_list.html', {'files': files})
